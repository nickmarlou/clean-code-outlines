# Рефакторинг

## Введение в рефакторинг

> [Мартин Фаулер](https://en.wikipedia.org/wiki/Martin_Fowler_(software_engineer)) определяет рефакторинг как **изменение внутренней структуры программы без изменения её наблюдаемого поведения, призванное облегчить понимание кода и удешевить его модификацию** (c. 553)

Зачастую код деградирует в процессе сопровождения или имеет невысокое качество изначально. На необходимость рефакторинга будет указывать множество знаков, которые иногда называют [code smell](https://en.wikipedia.org/wiki/Code_smell#:~:text=In%20computer%20programming%2C%20a%20code,%2C%20developer%2C%20and%20development%20methodology.&text=It%20is%20also%20a%20term%20used%20by%20agile%20programmers.).

### Разумные причины для выполнения рефакторинга (code smells)

- Одинаковые фрагменты кода повторяются в разных местах программы.
- Метод слишком велик (условно говоря, не помещается в экран).
- Цикл слишком велик или слишком глубоко вложен в другие циклы.
- Интерфейс класса не формирует согласованную асбтракцию.
- Метод принимает слишком много параметров.
- Отдельные части класса изменяются независимо от других частей (возможно, класс имеет несколько разных областей ответственности и тогда его нужно разделить на несколько классов).
- Несколько классов изменяются параллельно (возможно, эти классы можно объединить).
- Вам приходится параллельно изменять несколько иерархий наследования.
- Вам приходится параллельно изменить несколько условий.
- Метод использует больше элементов другого класса, чем своего собственного.
- Элементарный тип данных перегружен (для хранения денежных значений лучше создать тип `Money`, для хранения температуры – `Temperature` и так далее; это поможет избежать случаев присваивания данных неверного типа, как при использовании типа `decimal` для всех чисел с плавающей точкой).
- По цепи методов передаются бродячие данные.
- Объект-посредник ничего не делает.
- Один класс слишком много знает о другом классе (в таком случае нужно поработать над инкапсуляцией).
- Метод имеет неудачное имя (исправьте как можно быстрее!).
- Данные-члены сделаны открытыми (это редко бывает разумным решением, потому что стирает грань между интерфейсом и реализацией).
- Подкласс использует только малую долю методов своих предков.
- Сложный код объясняется при помощи комментариев (комментарий – лучше чем ничего, но еще лучше переписать код нормально).
- Код содержить глобальные переменные.
- Программа содержит код, который  «может когда-нибудь понадобится».

## Безопасность рефакторинга

Чтобы получить от рефакторинга только пользу и избежать вреда, следуйте этим советам:

- Сохраняйте первоначальную версию кода (скорее всего, Git это уже делает за вас, но не забудьте создать новую ветку для полной безопасности).
- Составьте список приёмов рефакторинга, которые вы хотите предпринять в ближайшее время.
- Составьте список приёмов, которые вы хотите выполнить в будущем.
- Выполняйте по одному приёму за раз и фиксируйте результат в случае успеха.
- Используйте регрессионное тестирование, чтобы убедиться, что изменения не привели к появлению ошибок.
- **Если наборы тестов не покрывают внесенные изменения, напишите дополнительные тесты или усовершенствуйте существующие.**
- Используйте предупреждения компилятора как сигналы о том, что изменения привели к ошибкам.
- Рефакторинг, как и любые другие изменения, должен быть предметом код-ревью.
- Чем масштабнее рефакторинг, тем осторожнее нужно быть.

Для безопасного рефакторинга не менее важно понимать, что рефакторинг – не панацея. Не стоит воспринимать его как повод сначала написать плохой код или как способ избежать переписывания кода.

> Иногда код невозможно улучшить небольшими изменениями – его нужно выбросить и переписать с нуля (с. 568)
